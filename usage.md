mongofile:usage:/how/to/use/this.lib
=======
This library use a different approach to accessing files and is more Java centric than the GridFS implementation is in the mongo-java-driver. Rather than having to cast the file objects, I made the decision to prefer static compile time type-checking and simplified object APIs over what is currently available from GridFS(2.11.4). 

The reading, writing, and query functions are separated from the main store code to keep usage more simple for the most common read and writes. 

Gzip compression is automatically detected based on media type of the file unless turned off in the configuration. Most media types will be stored compressed to save bytes ( even whole chunks ) in the store. This is handled transparently and the user does not need to know when compression is involved.

Also TTL expiration ( deletion ) will allow for usage as a cache to store objects that have a finite lifespan.

## URL 
A mongofile URL protocol has also been implemented to allow a single string to to represent all the info need to fetch the file back as well as give some metadata to the user wihtout having to query the store for basic metadata. Several examples look like this 

```
mongofile:/home/myself/foo/filename.zip?52fb1e7b36707d6d13ebfda9#application/zip
mongofile:gz:/mypath/fileName.pdf?52fb1e7b36707d6d13ebfda9#application/pdf
``` 
For the second example above, the parts of the URL represent :

| Part | Meaning |
| ----:|:--- |
| mongofile | the protocol |
| gz | compression was used to save space storing the file |
| /mypath/fileName.pdf | the file path and name |
| 52fb1e7b36707d6d13ebfda9 | a UUID id generated by the MongoDB driver for this object |
| application/pdf | the media type for the data |





## Stand up a MongoFileStore

Configure the connection to the MongoDB server and database in whatever fashion is available to you. Consult the MongoClient class from the driver for more Info.
 
THe database object below is a traditional com.mongodb.DB object.
```Java
MongoFileStoreConfig config = new MongoFileStoreConfig("myBucketName");

// optionally setup other params, default WriteConcern 
// for MongoFile is NORMAL since that is the driver's default
config.setChunkSize(chunkSize);
config.setWriteConcern(WriteConcern.SAFE);

MongoFileStore store = new MongoFileStore(database, config);
```
Keep this object handy, it is the core of all operations with file stored in MongoFS. If you are using Spring, make it a bean and inject this object where you need to acces files.





##Writing files into the store

```Java
MongoFileWriter writer = store.createNew("README.md", "text/plain", true);
writer.write(new ByteArrayInputStream(LOREM_IPSUM.getBytes()));
MongoFile file = writer.getMongoFile();
URL url = file.getURL();

System.out.println(url);
```
would print the following to stdout

```
mongofile:gz:README.md?52fb1e7b36707d6d13ebfda9#text/plain
```
where the parts represent : 

| Part | Meaning |
| ----:|:--- |
| mongofile | the protocol |
| gz | compression was used to save space storing the file |
| README.md | the file path and name |
| 52fb1e7b36707d6d13ebfda9 | a UUID id generated by the MongoDB driver for this object |
| text/plain | the media type for the data |

Store the url string how you like and use it to fetch the file back from the store when its needed. 

> REMEMBER : Filenames are *NOT* unique in the system, you can have many files with the same path and file name.




## Finding files from the store
Using a stored URL string 

```Java
MongoFileUrl url = MongoFileUrl.construct("mongofile:gz:README.md?52fb1e7b36707d6d13ebfda9#text/plain");
MongoFile mongoFile = store.getFile(url); // lookup the file by its url
  
ByteArrayOutputStream out = new ByteArrayOutputStream(32 * 1024);
store.read(mongoFile, out, true); // true == flush output stream when done

String fileText = out.toString();       
```

You can still read files by file name from the store as well.

```Java
ByteArrayOutputStream out = new ByteArrayOutputStream(32 * 1024);

MongoFileQuery query = store.query();
MongoFileCursor cursor =  query.find("/foo/bar1.txt");
int count = 0;
for (MongoFile mongoFile : cursor) {
    ++count;
    assertNotNull(mongoFile.getURL());
    assertEquals("/foo/bar1.txt", mongoFile.getFilename());
	InputStream in = store.read(mongoFile);
	new BytesCopier(in, out).transfer(true); // append more than one file together
}
assertEquals(2, count);
assertEquals(LOREM_IPSUM.length() * 2, out.toString().length());
```



## Removing files from the store

```Java
String storedSomewhereElse = "mongofile:gz:README.md?52fb1e7b36707d6d13ebfda9#text/plain";

MongoFileUrl url = MongoFileUrl.construct(storedSomewhereElse);
store.remove(url);
```




##Where to find more
Check out the integration tests in the source code, there are many examples of how to do things with mongoFS.


